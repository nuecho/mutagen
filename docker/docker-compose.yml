version: '3.2'
services:
  postgres_configserver:
    image: postgres:9.2 
    environment:
      - POSTGRES_PASSWORD=mysecretpassword
    volumes:
      - $PWD/sql_scripts/configserver/:/docker-entrypoint-initdb.d/

  configserver:
    image: dr.s.nuecho.com/genesys/config-server:8.5.1
    restart: on-failure
    environment:
      - PGPASSWORD=mysecretpassword
    depends_on:
      - postgres_configserver
    links:
      - postgres_configserver:postgres

  postgres_gax:
    image: postgres:9.2
    environment:
      - POSTGRES_PASSWORD=mysecretpassword
    volumes:
      - $PWD/sql_scripts/gax/:/docker-entrypoint-initdb.d/

  gax:
    image: dr.s.nuecho.com/genesys/gax:8.5.2
    hostname: gax # Gax installer will automatically creates cfgHost object with that name
    depends_on:
      - postgres_gax
      - configserver
    links:
      - postgres_gax:postgres
      - configserver

  test:
    image: dr.s.nuecho.com/mutagen-integration-tests:07ca1f476a193cfe0d8a77e292d99bedbf05f983
    environment:
      - CONFIG_SERVER_HOST=gax  # The container will wait for gax to be ready before running tests
      - CONFIG_SERVER_PORT=8080
    depends_on:
      - configserver
      - gax
    links:
      - configserver
      - gax
    volumes:
      - $PWD/../build/mutagen:/usr/local/bin/mutagen
      - $PWD/environments.yml:/root/.mutagen/environments.yml:ro
      - $PWD/gax_password:/tmp/gax_password:ro
      - $PWD/../tests:/usr/src/app/tests
